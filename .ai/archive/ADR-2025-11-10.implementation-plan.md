# ADR-2025-11-10.implementation-plan.md

## 1. Database Changes

**Description:** Database changes are required to support secure user authentication and admin onboarding for the Kwik Hub login flow.

**Migrations:**
- Create file: `src/main/resources/migrations/auth/1-create-user-table.sql` — Creates the `user` table with columns: `id`, `username`, `email`, `password_hash`, `created_by`, `created_at`, `modified_by`, `modified_at`. Include the required Liquibase changeset header: `--liquibase formatted sql\n\n-- changeset bagnascojhoel:auth-1-create-user-table context:auth`. Follow SQL conventions: UPPERCASE keywords, lowercase identifiers, table name in single quotes if reserved.
- Create file: `src/main/resources/migrations/auth/2-add-kwik-user.sql` — Inserts the initial admin user (`kwik-admin`) with password set via environment variable or securely generated. Include changeset header: `--liquibase formatted sql\n\n-- changeset bagnascojhoel:auth-2-add-kwik-user context:auth`.
- The master changelog `src/main/resources/migrations/changelog.xml` uses `includeAll` for automatic discovery of migrations in domain folders, so no manual updates are required.

**Indexes:**
- Add unique index on `username` and `email` columns in `user` table for fast lookup and uniqueness enforcement.

**Mitigation/Rollback:**
- Rollback scripts should drop the `user` table and remove the admin user if needed.

## 2. Library Changes

**Description:**
- Utilize existing `io.jsonwebtoken:jjwt-api` (with runtime deps) for JWT token generation and validation.
- Utilize existing `at.favre.lib:bcrypt` for secure password hashing.
- Rationale: Current libraries (`JJWT` and `at.favre.lib:bcrypt`) are sufficient and secure for the authentication flow, avoiding unnecessary dependencies.

## 3. Source Code Changes

**Presentation Layer:**
- Create/Update: `src/main/java/.../infra_driving/rest/AuthFlowJwtRestApi.java` — REST API for login, refresh, and check-state endpoints. Use `AuthFlowJwtRestApi` as pattern.
- Create/Update: `src/main/java/.../infra_driving/rest/AuthFlowJwtRestAdapter.java` — Adapter for REST API to application service.

**Application Layer:**
- Create/Update: `src/main/java/.../application/JwtFlowApplicationService.java` — Implements login, refresh, and check-state logic. Use existing application service patterns.

**Domain Layer:**
- Create/Update: `src/main/java/.../domain/User.java` — User entity with secure password handling. Use class diagram in ADR as reference.
Create/Update: `src/main/java/.../domain/Password.java` — Password value object for hashed password only (no salt). Use this VO across both application and domain layers for password handling.
- Create/Update: `src/main/java/.../domain/Jwt.java` — JWT value object.
- Create/Update: `src/main/java/.../domain/UserAuthenticationService.java` — Domain service for authentication logic.

**Infrastructure Layer:**
Create/Update: `src/main/java/.../infra_driven/repository/UserRepositoryAdapter.java` — Adapter for user persistence. Use repository interface patterns.
- Update file: `src/main/resources/application.properties` — Add configuration for JWT expiry, secure cookie flags, and admin password environment variable.

## 4. Test Code Changes

**Unit Tests:**
- Create/Update: `src/test/java/.../domain/UserTest.java` — Test user entity and password change logic. Use existing domain test patterns.
- Create/Update: `src/test/java/.../domain/PasswordTest.java` — Test password encryption and validation.
- Create/Update: `src/test/java/.../domain/JwtTest.java` — Test JWT creation and validation.
- Create/Update: `src/test/java/.../domain/UserAuthenticationServiceTest.java` — Test authentication scenarios.

**BDD Tests:**
Create/Update: `.feature` files in `src/test/resources/features/auth/` — Define user acceptance tests in Gherkin style.
- `login.feature`: Scenario(s) for successful login, failed login (invalid credentials), login with missing fields.
- `refresh.feature`: Scenario(s) for valid token refresh, refresh with expired/invalid token.
- `check-state.feature`: Scenario(s) for valid JWT state check, invalid/expired JWT state check.
Create/Update: Step definition classes in `src/test/java/.../infra_driving/rest/steps/` to implement the above scenarios.
Reference: Use existing Gherkin feature and step definition patterns from REST API tests.

**Fixtures/Test Data:**
- Reference: `src/test/resources/auth/user-fixtures.json` — Test users and passwords.

## 5. Documentation Changes

- Create file: `docs/features/kwik-hub-login-flow/ADR-2025-11-10.implementation-plan.md` — This implementation plan.
- Update file: `docs/features/kwik-hub-login-flow/README.md` — Add section describing login flow, endpoints, and security considerations. Use existing feature README files as patterns.
- Update file: `docs/features/kwik-hub-login-flow/openapi-spec.md` — Document new endpoints and request/response schemas. Use OpenAPI documentation patterns.
- Reference: Update external documentation if any API reference or onboarding guides exist for Kwik Hub authentication.

---

**Validation Checklist:**
- All sections included and formatted per prompt instructions
- All referenced files exist or are to be created
- Terminology and style consistent with ADR and codebase
- Plan aligns with ADR goals and constraints
- References to documentation and code patterns provided
