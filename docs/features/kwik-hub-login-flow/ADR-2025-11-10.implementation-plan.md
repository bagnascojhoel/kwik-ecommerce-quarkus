# Implementation Plan for ADR 2025-11-10

### 1 BDD Changes

#### Behavior Integration Tests and End-to-End Tests
- Create file: `src/test/resources/features/auth/jwt-authentication.feature`
  - Reference pattern: Existing .feature files in `src/test/resources/features/` for Gherkin scenario organization.
  - All scenarios for the JWT Authentication Flow, organized by feature, with @Integration for integration tests and @E2e for end-to-end tests.
  - Gherkin scenarios:
    ```
    Feature: JWT Authentication Flow

    @Integration
    Scenario: Successful login with valid credentials
      Given a user exists with username "kwik-admin" and a valid password
      When the login is attempted with correct username and password
      Then a JWT token is issued
      And the token is valid for 15 minutes

    @Integration
    Scenario: Failed login with invalid credentials
      Given a user exists with username "kwik-admin"
      When the login is attempted with incorrect password
      Then no JWT token is issued
      And an authentication error is returned

    @Integration
    Scenario: Refresh token with valid JWT
      Given a valid JWT token for user "kwik-admin"
      When the refresh is attempted with the valid token
      Then a new JWT token is issued
      And the new token is valid for 15 minutes

    @Integration
    Scenario: Refresh token with invalid JWT
      Given an invalid JWT token
      When the refresh is attempted with the invalid token
      Then no new JWT token is issued
      And an authentication error is returned

    @Integration
    Scenario: Check state with valid JWT
      Given a valid JWT token for user "kwik-admin"
      When the check-state is attempted with the valid token
      Then the state is reported as valid

    @Integration
    Scenario: Check state with invalid JWT
      Given an invalid JWT token
      When the check-state is attempted with the invalid token
      Then the state is reported as invalid

    @E2e
    Scenario: Successful login via REST API
      Given the application is running
      And a user exists with username "kwik-admin" and a valid password
      When a POST request is made to "/api/auth/flows/jwt/login" with correct credentials
      Then the response status is 200
      And a JWT cookie is set in the response

    @E2e
    Scenario: Refresh token via REST API
      Given the application is running
      And a valid JWT cookie is present
      When a POST request is made to "/api/auth/flows/jwt/refresh"
      Then the response status is 200
      And a new JWT cookie is set in the response

    @E2e
    Scenario: Check state via REST API
      Given the application is running
      And a valid JWT cookie is present
      When a POST request is made to "/api/auth/flows/jwt/check-state"
      Then the response status is 200
      And the response indicates valid state
    ```
  - Use object mother: `UserMother` for test data setup in step definitions.
- Update file: `src/test/java/br/com/bagnascojhoel/kwik/ecommerce/auth/JwtFlowIntegrationTest.java`
  - Reference pattern: Existing integration test runners in `src/test/java/br/com/bagnascojhoel/kwik/ecommerce/product/` for Cucumber runner configuration.
  - Runner for @Integration scenarios from the .feature file, mocking infrastructure.
- Update file: `src/test/java/br/com/bagnascojhoel/kwik/ecommerce/auth/JwtFlowE2eTest.java`
  - Reference pattern: Existing E2E test runners in `src/test/java/br/com/bagnascojhoel/kwik/ecommerce/product/` for Cucumber runner configuration.
  - Runner for @E2e scenarios from the .feature file, running against the full application.

### 2. Object Mother Changes
- Create file: `src/test/java/br/com/bagnascojhoel/kwik/ecommerce/auth/object_mother/UserMother.java`
  - Reference pattern: Existing object mother files in `src/test/java/br/com/bagnascojhoel/kwik/ecommerce/product/domain/` for domain object creation patterns.
  - Purpose: Provide consistent test fixtures for User entities with encrypted passwords and valid data sets.

### 3. Implementation Phases

#### Implementation Phase 1
- GOAL-001: Implement behavior integration tests using TDD for JWT authentication flow including refresh and check-state.
- Impacted layers: Application, Domain.
- Impacted files: `src/test/resources/features/auth/jwt-authentication.feature`, `src/test/java/br/com/bagnascojhoel/kwik/ecommerce/auth/JwtFlowIntegrationTest.java`, `src/main/java/br/com/bagnascojhoel/kwik/ecommerce/auth/application/JwtFlowApplicationService.java`.

#### Implementation Phase 2
- GOAL-002: Implement behavior end-to-end tests using TDD for JWT authentication flow including refresh and check-state.
- Impacted layers: Presentation, Infrastructure.
- Impacted files: `src/test/resources/features/auth/jwt-authentication.feature`, `src/test/java/br/com/bagnascojhoel/kwik/ecommerce/auth/JwtFlowE2eTest.java`, `src/main/java/br/com/bagnascojhoel/kwik/ecommerce/auth/infrastructure/driving/rest/AuthFlowJwtRestApi.java`, `src/main/java/br/com/bagnascojhoel/kwik/ecommerce/auth/infrastructure/driving/rest/AuthFlowJwtRestAdapter.java`.

#### Implementation Phase 3
- GOAL-003: Add refresh and check-state methods to JwtFlowApplicationService.
- Impacted layers: Application.
- Impacted files: `src/main/java/br/com/bagnascojhoel/kwik/ecommerce/auth/application/JwtFlowApplicationService.java`.

#### Implementation Phase 4
- GOAL-004: Add refresh and check-state endpoints to REST API and adapter.
- Impacted layers: Presentation.
- Impacted files: `src/main/java/br/com/bagnascojhoel/kwik/ecommerce/auth/infrastructure/driving/rest/AuthFlowJwtRestApi.java`, `src/main/java/br/com/bagnascojhoel/kwik/ecommerce/auth/infrastructure/driving/rest/AuthFlowJwtRestAdapter.java`.

#### Implementation Phase 5
- GOAL-005: Update admin user password handling for secure initialization.
- Impacted layers: Infrastructure.
- Impacted files: `src/main/resources/migrations/auth/2-add-kwik-user.sql`, startup logic if needed.

### 4. Database Changes
**Description:** User table and admin user already exist; update password handling for secure initialization.

**Migrations:**
- Update file: `src/main/resources/migrations/auth/2-add-kwik-user.sql`
  - Change password_hash from '<hash>' to use environment variable KWIK_ADMIN_PASSWORD or generate securely on startup.

### 5. Library Changes
None required for this implementation.

### 6. Source Code Changes
Impacted modules: Auth module for JWT authentication flow.

#### 6.1 Presentation Layer
- Update file: `src/main/java/br/com/bagnascojhoel/kwik/ecommerce/auth/infrastructure/driving/rest/AuthFlowJwtRestApi.java`
  - Reference pattern: Existing REST API interfaces for endpoint definitions.
  - Add endpoints:
    - POST /api/auth/flows/jwt/refresh: Request with JWT cookie, Response: 200 with new JWT cookie.
    - POST /api/auth/flows/jwt/check-state: Request with JWT cookie, Response: 200 with validity status, headers Cache-Control: no-store, no-cache, must-revalidate.
- Update file: `src/main/java/br/com/bagnascojhoel/kwik/ecommerce/auth/infrastructure/driving/rest/AuthFlowJwtRestAdapter.java`
  - Reference pattern: Existing adapter implementations for request/response mapping.
  - Add implementations for refresh and check-state methods.

#### 6.2 Application Layer
- Update file: `src/main/java/br/com/bagnascojhoel/kwik/ecommerce/auth/application/JwtFlowApplicationService.java`
  - Reference pattern: Existing application services for method additions.
  - Add methods: refresh(String token), checkState(String token).

#### 6.3 Domain Layer
None required; existing domain classes suffice.

#### 6.4 Infrastructure Layer
None required; existing implementations suffice.

#### 6.5 Resources
- Update file: `src/main/resources/application.properties`
  - Add JWT configuration: quarkus.jwt.duration=15m, secure cookie settings HttpOnly, SameSite=Strict, Secure.

### 7. Documentation Changes
- Create file: `docs/features/kwik-hub-login-flow/ADR-2025-11-10.implementation-plan.md`
  - Reference pattern: Existing ADR files for structure.

### 8. Unit Testing
- Update file: `src/test/java/br/com/bagnascojhoel/kwik/ecommerce/auth/domain/UserTest.java`
  - Reference pattern: Existing unit test files for domain entities.
  - Add test scenarios: Password change validation.
  - Use object mother: `UserMother`.
- Update file: `src/test/java/br/com/bagnascojhoel/kwik/ecommerce/auth/domain/PasswordTest.java`
  - Add test scenarios: Password encryption, salt generation.
- Update file: `src/test/java/br/com/bagnascojhoel/kwik/ecommerce/auth/domain/JwtTest.java`
  - Add test scenarios: Token parsing, expiry validation.

## 9. Risks & Assumptions

- **RISK-001**: Clock synchronization issues across distributed nodes could lead to token expiry problems.
  - Mitigation: Ensure NTP synchronization and short token expiry.
- **ASSUMPTION-001**: BCrypt and JWT libraries are already configured in the project.
- **ASSUMPTION-002**: Admin password is set via environment variable KWIK_ADMIN_PASSWORD or generated securely on startup.